# CUDA

#### CUDA简介

​	CUDA(Compute Unifide Device Architecture):是英伟达公司(nVIDIA)2006年11月提吃的一种通用并行的架构(应用于计算密集型,SIMD)，是一种通用并行计算平台和编程模型。是随着多核CPU和众核GPU的出现，而出现的新的并行程序架构。

​	CUDA设计为支持多种编程语言和应用程序接口！CUDA是在底层API的基础上，封装了一层，使得程序员可以使用C语言来方便的编程。

​	CUDA还支持C++/Python等更高级的语言编程；

​	此外，nVIDIA还提供了CuDNN，TensorRT，NPP等更高级的库函数。

​	==CUDA==(Compute Unified Device Architecture，计算机统一设备架构)，竞争对手OpenCL(from 2008，苹果公司)。

​	CUDA是nVIDIA专有的，即只能用nVIDIA的GPU。

​	OpenCL是所有nVIDIA主流媒介采用的一种标准，OpenCL可以在所有平台(nVIDIA,AMD等)执行，但是能否具有好的运行效果会有差异，同一时刻CUDA更快，CUDA未来会比OpenCL发展更快。

#### 计算能力(Compute Capability)

​	所谓计算能力(Compute Capability)，说白了就是GPU的版本号。有时也被称作SM Version。不同版本的GPU具有不同的特性，因此程序编写也会有所差异。计算能力为X，Y，其中X代表架构，Y代表次版本号。

#### 英伟达GPU系列

#### 可扩展的编程模型

​	CUDA的编程模型，使得同一个CUDA程序，可以在不同的显卡上运行。如图所示，CUDA程序会创建一些线程块(Block)，线程块会被调度到空闲的==流处理簇(SM)==上去。当线程执行完毕后，线程块会退出SM，释放出SM的资源，以供其他待执行线程块调度进去。

​	因此，无论是只有两个SM的GPU，还是有4个SM的GPU，这些线程块都会被调度执行，只不过执行的时间有长有短。

​	GPU在编程时被称为设备(device)端，CPU被称为主机(host)端

​	GPU段代码需要以核函数的形式加载，执行在GPU设备端

#### 线程层级

​	在讲内核函数前，先讲解一下线程层级。CUDA编程时一个多线程编程，数个线程(Thread)组成一个线程块(Block)，所有线程块组成一个线程网格(Grid)，图中的线程块，以及线程块的线程，是按照二维的方式排布的。实际上，CUDA编程模型允许使用一维、二维、三维三种方式来排布。

​	另外，即使线程块使用的是一维排布，线程块中的线程也不一定要按照一维排，而是可以任意排布。

​	目前的GPU限制一个线程块中，最多可以安排1024个线程。一个线程块用多少线程，以及一个线程网格用多少线程块，是程序员可以自由安排的。==由于32个相邻的线程会组成一个线程束(Tread Wrap)，而一个线程束中的线程会运行同样的指令==

​	因此一般线程块中线程的数量被安排为32的倍数，选用256是比较合适的。在线程数定下来之后，一般根据数据的排布情况来确定线程块的个数(一维排列256，二维排列(16,16))

​	例如：一个数组的长度为4096，安排每个线程处理一个元素。如果安排一个线程块为256个线程，则需要4096/256=16个线程块

#### 内核函数(Kernels)

​	内核函数是CUDA__每个线程__执行的函数，它运行在GPU设备上。CUDA使用扩展的C语言编写内核函数，关键字为\_\__global\_\__。内核函数返回值只能是void。定义格式：

```
__global__ void 函数名 (参数......)
{
	指令集和
}
```

​	主函数的调用格式：

```
函数名 <<<blocksPerGrid, threadsPerBlock>>>(参数...)
```

​	blocksPerGrid：每个网格中进程块的排布方式(可以采用一维或二维)

​	threadsPerBlock：每个进程块中进程的排布方式(可以采用一维或二维)

1. 多个thread集结成一个block，多个bolck集结成一个grid。
2. 一个block里面的线程数，以及一个grid里面的block数完全是由编程人员去决定的，但是数量的多少和排布方式会根据不同问题产生不同的效果，同时会影响到运行的效率，所以这是GPU优化速度的一个关键因素(==计算线程和数据的对应关系也不同==)
3. block里面的thread可以以1d，2d，3d的方式进行排布；grid里面的block也可以以1d，2d，3d的方式进行排布。
4. 每个核函数都可以通过预定义的变量名称去访问各个线程，如threadidx，blockidx，blockDim，gridDim的(.x,.y)分量
5. 线程块，网格的设定需要用<<<gridset, blockset>>>括起来。
6. 内建类型dim3可以设定grid或block里面二维，三维的结构模型，如dim3 BLOCKs(2，2)
7. 核函数前面需要加\_\_global\_\_进行限定，并且必须是没有返回值的void函数
8. 主机端函数可以是C++的，但是kernel中必须是C的，而且很多C中字符串相关的函数在目前来说都不能使用

